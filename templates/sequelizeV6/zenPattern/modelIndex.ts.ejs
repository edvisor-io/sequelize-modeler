import * as path from 'path'
import {
  Model,
  Sequelize
} from 'sequelize'

import { eachFileInDir } from '../../utils'
import { AppSchema } from '../schema'
<%_
setOutputFileName('server/sequelize/models/index.ts')
tables.forEach((table) => {
  const modelName = include('_partials/modelNames.ejs', {
    modelName: changeCase.pascalCase(table.name),
  }) -%>
import { <%= modelName %>Ctor } from './<%= changeCase.paramCase(modelName) %>'
<%_ }) -%>

export function initAllModels(sequelize: Sequelize) {
  eachFileInDir(__dirname, file => {
    const modelFilePath = path.join(__dirname, file)
    const model = require(modelFilePath).default as typeof Model
    const { init }: AppSchema<typeof Model> = require(modelFilePath).schema

    init(sequelize, model)
  })
}

export function initAllAssociations(models: SequelizeModels) {
  eachFileInDir(__dirname, file => {
    const modelFilePath = path.join(__dirname, file)
    const { associate }: AppSchema<typeof Model> = require(modelFilePath).schema

    associate(models)
  })
}


export type SequelizeModels = {
<%_ tables.forEach(table => {
  const modelName = include('_partials/modelNames.ejs', {
    modelName: changeCase.pascalCase(table.name),
  }) -%>
  <%= modelName %>: <%= modelName %>Ctor
<%_ }) -%>
}
